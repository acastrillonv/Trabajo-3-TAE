---
title: "Análisis de incidentes viales en la ciudad de Medellín"
author: "Valentina Vanegas Castaño <br> Edwar Jose Londoño Correa <br> Andres Castrillón Velasquez <br> Diego Andres Chavarria Riaño <br> Sebastian Rendon Arteaga"
format: html
editor: visual
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = F,warning = F)
```

```{r}
library(kableExtra)
library(dplyr)
library(stringr)
```

# 1- Contexto del problema

sskks

```{r}
#Carga del dataset
data <- read.csv("incidentes_viales.csv", encoding = "UTF-8", header = TRUE, sep = ";", dec = ".")
#head(data)
```

# 2- Procesamiento de los datos

la Tabla 1, se puede observar que en su mayoria, casi todas las variables son de tipo "character", exceptuando las variables "MES" y "NRO_RADICADO" que son de tipo "integer" y la variable "Y.." que es de tipo "numeric".

```{r}
analisis_de_variables<-as.data.frame(lapply(data, class))

kable(analisis_de_variables,caption = "Tipo de variable") %>% 
  kable_styling(full_width = F,position = "center") %>% 
  kable_minimal()
```

<center>**Tabla 1.** Tipo de variable de cada columna del dataset "Data"</center>

<br>

Para el procesamiento de los datos, vamos analizar principalmente la variable "AÑO". Como podemos observar en la Tabla 2, la cual muestra los primeros 10 valores diferentes en esta variable, existen diferentes errores. El primero que podemos identificar es que existe un error de tipado para el año 2019, el cual aparece "2019\\r". Otro error que se puede observar es que hay error de almacenamiento en esta misma variable. Por último, como regla del proyecto, no se va a trabajar con registros del año 2017.

```{r}
#Frecuencia de la variable ano

kable(head(data %>% group_by(AÑO) %>% summarise(n = n()) %>% arrange(-n),10),caption = "AÑO") %>% 
  kable_styling(full_width = F,position = "center") %>% 
  kable_minimal()
```

<center>**Tabla 2.** Primeros 10 valores únicos de la variable "AÑO"</center>

<br>

```{r}
#Correcion del año 2019

data <- data %>% mutate(AÑO = ifelse(AÑO ==  "2019\\r" , "2019", AÑO))


#Correcion error 2

##Se separa en dataframe aux los registros con error 2
dataAux <- subset(data, data$AÑO!= "2014" & data$AÑO!= "2015" & data$AÑO!= "2016" & data$AÑO!= "2017" & data$AÑO!= "2018" & data$AÑO!= "2019" & data$AÑO!= "2020")

##Se eliminan del dataset original los registros con error 2
Filtro <- is.element(data$AÑO,dataAux$AÑO)
data <- data[! Filtro,]

##Se corrige la variable ano
Correcion_ano <- strsplit(dataAux$AÑO, ";")
Correcion_ano <- as.data.frame(Correcion_ano)
Correcion_ano <- t(Correcion_ano)

rownames(Correcion_ano) <- 1:nrow(Correcion_ano)
Correcion_ano <- as.data.frame(Correcion_ano)
names(Correcion_ano) <- c("AÑO", "CBML", "CLASE_ACCIDENTE", "DIRECCION", "DIRECCION.ENCASILLADA","DISEÑO","EXPEDIENTE","FECHA_ACCIDENTE","FECHA_ACCIDENTES","GRAVEDAD_ACCIDENTE","MES",
"NRO_RADICADO", "NUMCOMUNA", "BARRIO", "COMUNA", "LOCATION")

##Se corrige la variable x
X_union <- as.data.frame(dataAux$CBML)
names(X_union) <- c("X")

##Se corrige la variable Y
Y_union <- as.data.frame(dataAux$CLASE_ACCIDENTE)

for(fila in 1:nrow(Y_union)){
  Y_union[fila,] <- str_sub(Y_union[1,],1,nchar(Y_union[1,])-1)
}
names(Y_union) <- c("Y..")

data_cor_union <- data.frame(Correcion_ano,X_union,Y_union)

data_corregida <- rbind(data,data_cor_union)

# Se vuelve a corregir la variable año 2019

data_corregida <- data_corregida %>% mutate(AÑO = ifelse(AÑO ==  "2019\\r" , "2019", AÑO))

#Se eliminan los registros del año 2017

data_corregida <- data_corregida[data_corregida$AÑO != "2017", ]

#Se corrige el index del dataframe final
rownames(data_corregida) <- 1:nrow(data_corregida)
```

Una vez corregido lo anterior, En la tabla 3 podemos visualizar las nuevas frecuencias de los datos únicos de la variable "AÑO"

```{r}
#Frecuencia de la variable ano corregida

kable(data_corregida %>% group_by(AÑO) %>% summarise(n = n()) %>% arrange(-n),caption = "AÑO Corregido") %>% 
  kable_styling(full_width = F,position = "center") %>% 
  kable_minimal()
```

<center>**Tabla 3.** Valores únicos de la variable "AÑO" corregidos</center>

<br>

Ahora, relizamos el análisis de la variable "CLASE_ACCIDENTE". En la Tabla 4, podemos observar que existen errores de escritura con la clase accidente "Caída de Ocupante", la cual se corregirá con este estandar. También se corregirán los valores que se muestran como "" por "Otro".

```{r}

kable(data_corregida %>% group_by(CLASE_ACCIDENTE) %>% summarise(n = n()) %>% arrange(-n),caption = "Clase de Accidentes") %>% 
  kable_styling(full_width = F,position = "center") %>% 
  kable_minimal()
```

<center>**Tabla 4.** Valores únicos de la variable "CLASE_ACCIDENTE"</center>

<br>

```{r}
#Correcion de la variable clase accidente

data_corregida[data_corregida$CLASE_ACCIDENTE == "Caida de Ocupante",3] <- "Caída de Ocupante"
data_corregida[data_corregida$CLASE_ACCIDENTE == "Caida Ocupante",3] <- "Caída de Ocupante"
data_corregida[data_corregida$CLASE_ACCIDENTE == "Caída Ocupante",3] <- "Caída de Ocupante"

```

Realizando las modificaciones de los errores anteriores, se puede observar en la Tabla 5 los valores únicos corregidos.

```{r}

kable(data_corregida %>% group_by(CLASE_ACCIDENTE) %>% summarise(n = n()) %>% arrange(-n),caption = "Clase de Accidentes corregidos") %>% 
  kable_styling(full_width = F,position = "center") %>% 
  kable_minimal()
```

<center>**Tabla 5.** Valores únicos de la variable "CLASE_ACCIDENTE" corregidos</center>

<br>

Realizando de manera similar el análisis en la variable "DISEÑO", en la Tabla 6 se pueden observar los valores únicos para esta variable, y se observa que existen errores de escritura.

```{r}

kable(head(data_corregida %>% group_by(DISEÑO) %>% summarise(n = n()) %>% arrange(-n),17),caption = "Diseño") %>% 
  kable_styling(full_width = F,position = "center") %>% 
  kable_minimal()
```

<center>**Tabla 6.** Valores únicos de la variable "DISEÑO"</center>

<br>

```{r}
#Correción de la variable Diseño

##Error 1
data_corregida[data_corregida$DISEÑO == "Pont\\xF3n",6] <- "Pontón"

##Error 2

##Se separa en dataframe aux los registros con error 2
dataAux <- subset(data_corregida, data_corregida$DISEÑO!= "Tramo de via" & data_corregida$DISEÑO!= "Interseccion" & data_corregida$DISEÑO!= "Lote o Predio" & data_corregida$DISEÑO!= "Glorieta" & data_corregida$DISEÑO!= "Paso Elevado" & data_corregida$DISEÑO!= "Puente" & data_corregida$DISEÑO!= "Ciclo Ruta" & data_corregida$DISEÑO!= "Paso Inferior" & data_corregida$DISEÑO!= "Paso a Nivel" & data_corregida$DISEÑO!= "Tunel" & data_corregida$DISEÑO!= "Via peatonal" & data_corregida$DISEÑO!= "Pontón" & data_corregida$DISEÑO!= '""')

dataAux2 <- subset(dataAux, select = c(AÑO,CBML, CLASE_ACCIDENTE, DIRECCION))

dataAux<- subset(dataAux, select = -c(AÑO,CBML, CLASE_ACCIDENTE, DIRECCION))

##Se eliminan del dataset original los registros con error 2
Filtro <- is.element(data_corregida$DIRECCION.ENCASILLADA, dataAux$DIRECCION.ENCASILLADA)
data_corregida <- data_corregida[! Filtro,]

##Se corrige la variable ano
Correcion_de <- strsplit(dataAux$DIRECCION.ENCASILLADA, ";")
Correcion_de <- as.data.frame(Correcion_de)
Correcion_de <- t(Correcion_de)
rownames(Correcion_de) <- 1:nrow(Correcion_de)
Correcion_de <- as.data.frame(Correcion_de)
names(Correcion_de) <- c("DIRECCION.ENCASILLADA","DISEÑO","EXPEDIENTE","FECHA_ACCIDENTE","FECHA_ACCIDENTES","GRAVEDAD_ACCIDENTE","MES","NRO_RADICADO", "NUMCOMUNA", "BARRIO","COMUNA","LOCATION")

##Se corrige la variable x
X_union <- as.data.frame(dataAux$DISEÑO)
names(X_union) <- c("X")

##Se corrige la variable Y
Y_union <- as.data.frame(dataAux$EXPEDIENTE)
names(Y_union) <- c("Y..")

data_cor_union <- data.frame(dataAux2,Correcion_de,X_union,Y_union)

data_corregida <- rbind(data_corregida,data_cor_union)

#Se corrige el index del dataframe final
rownames(data_corregida) <- 1:nrow(data_corregida)
```

Una vez corregido los errores anteriormente mencionados, en la Tabla 7 se puede observar los valores únicos de la variable diseño corregidos.

```{r}
kable(data_corregida %>% group_by(DISEÑO) %>% summarise(n = n()) %>% arrange(-n),caption = "Diseño corregidos") %>% 
  kable_styling(full_width = F,position = "center") %>% 
  kable_minimal()
```

<center>**Tabla 7.** Valores únicos de la variable "DISEÑO" corregidos</center>

<br>

Continuando con la variable "GRAVEDAD_ACCIDENTE", se procede a realizar el mismo análisis que en las variables anteriores.

```{r}

kable(data_corregida %>% group_by(GRAVEDAD_ACCIDENTE) %>% summarise(n = n()) %>% arrange(-n),caption = "Gravedad Accidente") %>% 
  kable_styling(full_width = F,position = "center") %>% 
  kable_minimal()
```

<center>**Tabla 8.** Valores únicos de la variable "GRAVEDAD_ACCIDENTE" </center>

<br>

En la Tabla 8, podemos observar que existe un error de escritura y que este es corregido como se puede observar en la Tabla 9.

```{r}
#Correcion de GRAVEDAD_ACCIDENTE
data_corregida[data_corregida$GRAVEDAD_ACCIDENTE == "Solo da\\xF1os",10] <- "Solo daños"
```

```{r}
kable(data_corregida %>% group_by(GRAVEDAD_ACCIDENTE) %>% summarise(n = n()) %>% arrange(-n),caption = "Gravedad Accidente corregidos") %>% 
  kable_styling(full_width = F,position = "center") %>% 
  kable_minimal()
```

<center>**Tabla 9.** Valores únicos de la variable "GRAVEDAD_ACCIDENTE" corregidos </center>

<br>

```{r}
kable(data_corregida %>% group_by(MES) %>% summarise(n = n()) %>% arrange(-n),caption = "Gravedad Accidente corregidos") %>% 
  kable_styling(full_width = F,position = "center") %>% 
  kable_minimal()
```

```{r}
#dplyr::count(data, AÑO, sort = TRUE)
```

```{r}

#p<- is.nan(data$AÑO)
```

```{r}

apply(is.na(data_corregida),2,sum)

#kable(apply(is.na(data_corregida),2,sum),caption = "Cantidad de datos perdidos (NA) por cada variable") %>% 
  #kable_styling(full_width = F,position = "center") %>% 
  #kable_minimal()
```

<center>**Tabla 2.** Cantidad de datos perdidos (NA) por cada columna del dataframe "Data"</center>

<br>

```{r}
#Seleccion de variables

#data <- subset(data, select = -c(DIRECCION, "DIRECCION ENCASILLADA", EXPEDIENTE, NRO_RADICADO, LOCATION, NUMCOMUNA))
```
